"""
テスト運用ガイド
"""

# ファンディングレート裁定ボット テスト運用ガイド

このドキュメントでは、ファンディングレート裁定ボットのテスト運用手順を説明します。テスト運用では、少額（100USD相当のBTC）でボットの動作を検証します。

## テスト運用の準備

### 1. 環境のセットアップ

1. リポジトリをクローンし、必要なパッケージをインストールします：

```bash
git clone <リポジトリURL>
cd crypto_arbitrage_bot
python -m venv venv
source venv/bin/activate  # Windowsの場合: venv\Scripts\activate
pip install -r requirements.txt
```

2. `.env`ファイルを作成し、必要な環境変数を設定します：

```bash
cp .env.example .env
```

3. `.env`ファイルを編集し、以下の項目を設定します：
   - `SOLANA_PRIVATE_KEY_PATH`: Solanaキーペアのパス
   - `SOLANA_RPC_URL`: SolanaのRPC URL
   - `BYBIT_API_KEY`: BybitのAPIキー
   - `BYBIT_API_SECRET`: BybitのAPIシークレット
   - その他の設定パラメータ

### 2. テストモードの設定

テスト運用では、以下の設定を推奨します：

- `BYBIT_TESTNET=true`: Bybitのテストネットを使用
- `POSITION_SIZE_USD=10`: 小さいポジションサイズでテスト
- `CHECK_INTERVAL_SECONDS=300`: 短い間隔でチェック（5分）
- `LOG_LEVEL=DEBUG`: 詳細なログを出力

## テスト運用の手順

### 1. ドライランモード

まず、実際の取引を行わずにボットのロジックをテストします。

1. `src/bot.py`を編集し、`DRY_RUN=True`を設定します（または環境変数で設定）。
2. ボットを実行します：

```bash
python -m src.bot
```

3. ログを確認し、ボットが正しくファンディングレートを取得し、裁定機会を検出できるか確認します。

### 2. テストネットでのテスト

次に、テストネットで実際の取引をテストします。

1. Bybitのテストネットアカウントを設定し、テスト用の資金を入金します。
2. Solanaのテストネットウォレットを設定し、テスト用のSOLを入金します。
3. `.env`ファイルで`BYBIT_TESTNET=true`を設定します。
4. ボットを実行します：

```bash
python -m src.bot
```

5. ログとテストネットアカウントを監視し、ボットが正しく動作しているか確認します。

### 3. 本番環境での少額テスト

テストネットでの検証が成功したら、本番環境で少額のテストを行います。

1. `.env`ファイルで`BYBIT_TESTNET=false`を設定します。
2. `POSITION_SIZE_USD=10`など、小さい金額に設定します。
3. ボットを実行します：

```bash
python -m src.bot
```

4. ログと実際のアカウントを監視し、ボットが正しく動作しているか確認します。

## テスト中の確認事項

テスト運用中は、以下の点を確認してください：

1. **ファンディングレートの取得**: 両取引所からファンディングレートが正しく取得できているか
2. **裁定機会の検出**: 設定したしきい値に基づいて裁定機会が正しく検出されているか
3. **ポジションの構築**: 裁定機会が検出された場合、正しくポジションが構築されているか
4. **ポジションのバランス**: 両取引所のポジションが適切にバランスされているか
5. **リスク管理**: 価格乖離や不均衡が検出された場合、適切に対応しているか
6. **エラーハンドリング**: エラーが発生した場合、適切に処理されているか
7. **ログ記録**: 重要なイベントが適切にログに記録されているか

## テスト結果の評価

テスト運用後、以下の点を評価してください：

1. **技術的な安定性**: ボットが安定して動作したか、クラッシュや予期しないエラーはなかったか
2. **戦略の有効性**: 裁定機会を正しく検出し、利益を得ることができたか
3. **リスク管理の有効性**: リスクが適切に管理されたか
4. **パフォーマンス**: 実行速度や資源使用量は適切か
5. **改善点**: テスト中に発見された問題や改善点はあるか

## 本番運用への移行

テスト運用が成功したら、以下の手順で本番運用に移行します：

1. テスト結果に基づいてパラメータを調整します。
2. Render.comなどのクラウドプラットフォームにデプロイします。
3. 定期的な監視とメンテナンスの計画を立てます。

## トラブルシューティング

テスト中に問題が発生した場合は、以下の点を確認してください：

1. **API接続エラー**: APIキーとシークレットが正しいか、ネットワーク接続に問題がないか
2. **認証エラー**: Solanaキーペアが正しいか、十分な資金があるか
3. **取引エラー**: 取引所の制限やルールに違反していないか
4. **ロジックエラー**: ボットのロジックに問題がないか
5. **環境変数エラー**: 環境変数が正しく設定されているか

詳細なエラーメッセージはログファイルを確認してください。
